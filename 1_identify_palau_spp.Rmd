---
title: 'Identify species found in Palau EEZ'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(raster)
library(data.table)

source('https://raw.githubusercontent.com/oharac/src/master/R/common.R')
  ### includes library(tidyverse); library(stringr); 
  ### dir_M points to ohi directory on Mazu; dir_O points to home dir on Mazu

source('common_fxns.R')
```

# Summary

Having identified cells in the Palau EEZ, using the 100 km^2^ cell and EEZ map as a quick check, identify species found in Palau EEZ.  Copy those spp rasters over to Github for more universal access.

## Identify Palau EEZ cells

Palau EEZ for OHI is region 8.  This can be updated later using the Palau EEZ shapefile but should be a good start for now.

```{r}

cell_id_rast <- raster('spatial/cell_id_rast.tif')
eez_rast     <- raster('spatial/eez_rast.tif')

eez_cells_df <- data.frame(cell_id = values(cell_id_rast),
                           eez     = values(eez_rast)) %>%
  filter(eez == 8)

write_csv(eez_cells_df, 'spatial/palau_cell_ids.tif')

```

## Get all the species in each cell using the original raster extracts

Pull the species IDs from the rasterized species maps.  For each map (as a `.csv` file), check whether the `cell_id`s in the Palau EEZ match `cell_id`s within the species map.  If so, flag it as local, and copy to a folder in Github.

``` {r get_spp_in_palau_eez}

palau_spp_maps_file <- 'data/palau_spp_maps.csv'

if(!file.exists(palau_spp_maps_file)) {
  
  spp_rasts <- list.files(file.path(dir_o_anx, 'spp_rasters'), full.names = TRUE)
  palau_eez_cells <- eez_cells_df$cell_id
  
  for(i in seq_along(spp_rasts)) {
    ### i <- 1
    rast <- spp_rasts[i]
    message('processing ', i, ' of ', length(spp_rasts), ': ', basename(rast))
    rast_cells <- read_csv(rast) %>%
      filter(cell_id %in% palau_eez_cells)
    if(nrow(rast_cells) == 0) {
      palau_spp_df$in_eez <- FALSE
    } else {
      palau_spp_df$in_eez <- TRUE
      write_csv(rast_cells, file.path('spp_rasts', basename(rast)))
    }
  }

  ### Create a dataframe showing which species are found in the Palau EEZ
  palau_spp_df <- data.frame(spp_rast = basename(spp_rasts), in_eez = NA) %>%
    mutate(spp_id = str_extract(spp_rasts, '[0-9]+') %>% as.integer()) %>%
    mutate(in_eez = file.exists(file.path('spp_rasts', spp_rast)))
  
  write_csv(palau_spp_df, palau_spp_maps_file)
}

```

``` {r attach_spp_info}

spp_risk <- read_csv('data/iucn_risk_current_2019-2.csv') %>%
  arrange(cat_score) %>%
  mutate(cat = fct_inorder(cat))
  

palau_spp <- read_csv(palau_spp_maps_file) %>%
  filter(in_eez) %>%
  left_join(spp_risk, by = c('spp_id' = 'iucn_sid')) %>%
  filter(!is.na(cat))

ggplot(palau_spp, aes(x = cat, fill = cat)) +
  geom_bar() +
  theme_classic() +
  scale_fill_manual(values = c('green4', 'yellow3', 'orange2', 'red3', 'red4', 'grey60')) +
  labs(x = 'IUCN conservation status',
       y = 'Log (count)') +
  scale_y_log10()

DT::datatable(palau_spp %>% select(-spp_rast, -old_cat, -in_eez))
```


``` {r old stuff, eval = FALSE}

spp_ranges   <- read_csv(file.path(dir_data, sprintf('iucn_spp_range_area_%s.csv', api_version)),
                         col_types = 'dd__') %>%
  distinct()

### make a dataframe of species risk and regional risk
spp_risk_all <- spp_risk %>%
  mutate(iucn_rgn = 'global') %>%
  bind_rows(spp_risk_rgn) %>%
  left_join(spp_ranges, by = c('iucn_sid')) %>%
  select(iucn_sid, sciname, iucn_rgn, cat_score, range_km2) %>%
  mutate(range_km2 = round(range_km2))

cells_info <- read_csv(cell_summary_file, col_types = 'd__cd____id') %>%
  distinct()

lme_to_rgn <- read_csv(file.path(dir_git, 'spatial/iucn_rgn_to_lme.csv')) %>%
  rename(rgn_name = iucn_rgn) %>%
  distinct()

taxa_cells_info <- read_csv(taxa_cells_file, col_types = 'ddcc') %>%
  left_join(spp_risk_all, by = 'iucn_sid') %>%
  mutate(spp_gp = tolower(spp_gp)) %>%
  left_join(cells_info, by = c('cell_id')) %>%
    ### add info from rasters, including lme_id
  left_join(lme_to_rgn, by = c('lme_id')) %>%
    ### add region names to filter out regional assessments
  mutate(rgn_name = ifelse(is.na(lme_id), 'global', rgn_name),
         priority = ifelse(rgn_name == 'global', 100, priority)) %>%
    ### LME cells already tagged 'global'; fix non-LME cells  and set low-ranking priority
  filter(iucn_rgn == rgn_name) %>%
  group_by(cell_id, iucn_sid) %>%
  filter(priority == min(priority)) %>%
    ### for each spp in each cell, choose the obs with highest-ranking priority
  ungroup()

spp_cells_info <- taxa_cells_info %>%
  select(cell_id, iucn_sid, sciname, spp_gp, iucn_rgn, 
         cat_score, range_km2, cell_group, depth, spp_max_depth = max_depth)

write_csv(spp_cells_info, file.path(dir_git, 'data_explore', 'spp_cells_scores.csv'))

```



